# Makefile for es ($Revision: 1.4 $)

# Some of the advice here is rather old and out of date.  The
# configuration of es will be improved by 0.9beta, but I didn't
# want to hunt out machines from now til eternity.

# comment out the CFLAGS -Wall if you're not using gcc,
# but i'd encourage you to compile with full warnings on.
# let us know what warnings you get, though we don't promise
# to shut them all up.  if you're using sun's SPARCcompiler
# we recommend -Xa mode.  if you're using the native alpha
# compile, we recommend -g3 -O -Olimit 1000.  on recent
# SGI Irix releases using the native compiler, you will
# probably need -xansi.

# see config.h for command-line -D flags you may want to use.
# if you're using SunOS 5 (Solaris 2), be sure to include
# -DSOLARIS in the CFLAGS, since sun made it difficult to
# detect which system you're running.  also, since sun really
# seems to have screwed up and removed both getrusage() and
# wait3() in Solaris 2, you should probably add -DBUILTIN_TIME=0
# to the cflags.  if you're running an OSF1 derivative, try -DOSF1.
# if you're using HP/UX do a -DHPUX.

# also, please use whatever -D flags you need to in order
# to get definitions of all signals from <sys/signal.h>.
# _POSIX_SOURCE, _XOPEN_SOURCE are the obvious ones.

prefix  = @prefix@
datarootdir = @datarootdir@
exec_prefix	= @exec_prefix@
mandir	= @mandir@
bindir	= @bindir@
srcdir  = @srcdir@
ENABLE_LOGINSHELL = @ENABLE_LOGINSHELL@


SHELL	= /bin/sh
CC	= @CC@
INSTALL	= @INSTALL@
MKDIR_P = @MKDIR_P@

YACC = @YACC@

CFLAGS	= $(ADDCFLAGS) -I. -I$(srcdir) -W -Wall -Wno-missing-field-initializers -Wno-unused-parameter @CFLAGS@
LDFLAGS	= $(ADDLDFLAGS) @LDFLAGS@
LIBS	= $(ADDLIBS) @LIBS@

VPATH = $(srcdir)

HFILES	= config.h es.h gc.h input.h prim.h print.h sigmsgs.h \
	  stdenv.h syntax.h var.h esconfig.h eval.h
CFILES	= access.c closure.c conv.c dict.c eval.c except.c fd.c gc.c glob.c \
	  glom.c input.c heredoc.c list.c main.c match.c open.c opt.c \
	  prim-ctl.c prim-etc.c prim-io.c prim-sys.c prim.c print.c proc.c \
	  sigmsgs.c signal.c split.c status.c str.c syntax.c term.c token.c \
	  tree.c util.c var.c vec.c version.c y.tab.c dump.c gc_common.c ms_gc.c \
	  prim-dict.c
OFILES	= access.o closure.o conv.o dict.o eval.o except.o fd.o gc.o glob.o \
	  glom.o input.o heredoc.o list.o main.o match.o open.o opt.o \
	  prim-ctl.o prim-etc.o prim-io.o prim-sys.o prim.o print.o proc.o \
	  sigmsgs.o signal.o split.o status.o str.o syntax.o term.o token.o \
	  tree.o util.o var.o vec.o version.o y.tab.o gc_common.o ms_gc.o \
	  prim-dict.o
OTHER	= Makefile parse.y mksignal getsigfiles
SYSLIB = initial.es config.es macros.es dict.es applymap.es \
		 libraries.es range.es glob.es complete.es gc.es \
		 parseargs.es doiterator.es newvars.es suffix.es \
		 initialize.es
GEN	= esdump y.tab.c y.tab.h y.output token.h sigmsgs.c system.c config.es

es	: ${OFILES} system.o
	${CC} -o es ${LDFLAGS} ${OFILES} system.o ${LIBS}

esdump	: ${OFILES} dump.o
	${CC} -o esdump ${LDFLAGS} ${OFILES} dump.o ${LIBS}

es_static : ${OFILES} system.o
	${CC} -static -o es_static ${LDFLAGS} ${OFILES} system.o ${LIBS}

clean	:
	rm -f es es_static ${OFILES} ${GEN} dump.o system.o version.c

distclean:	clean
	rm -f config.cache config.log config.h Makefile cscope.out tags TAGS core cs.out config.status ltmain.sh
	rm -rf autom4te.cache 

MANIFEST:
	find . -type f | sed s/..// > MANIFEST

install : es
	$(MKDIR_P) $(bindir)
	./es -N preinstall.es $(bindir)
	$(INSTALL) -s $(srcdir)/es $(bindir)
	$(INSTALL) $(srcdir)/esdebug $(bindir)
	chmod +x $(bindir)/esdebug
	$(MKDIR_P) $(mandir)/man1
	$(INSTALL) $(srcdir)/doc/es.1 $(mandir)/man1

userlib-install : es
	./es -N libinstall.es $(srcdir)/libraries

syslib-install : es
	./es -N libinstall.es $(srcdir)/libraries $(datarootdir)/es


test	: estest

trip	: es $(srcdir)/trip.es
	./es < $(srcdir)/trip.es

estest : es
	./es -- ./estest -xyl

src	:
	@echo ${OTHER} ${CFILES} ${HFILES}

y.tab.c y.tab.h : parse.y
	${YACC} -vd $(srcdir)/parse.y

token.h : y.tab.h
	-cmp -s y.tab.h token.h || cp y.tab.h token.h

config.es:
	echo "# autogenerated file " > $(srcdir)/config.es
	echo "corelib = '${datarootdir}/es'" >> $(srcdir)/config.es
	echo "es_use_new_vars = true" >> $(srcdir)/config.es
	echo "es_enable_loginshell = ${ENABLE_LOGINSHELL}" >> $(srcdir)/config.es
	echo "" >> $(srcdir)/config.es

system.c : esdump ${SYSLIB}
	cat ${SYSLIB} | ./esdump > system.c

sigmsgs.c : mksignal getsigfiles
	sh $(srcdir)/getsigfiles | xargs sh $(srcdir)/mksignal > sigmsgs.c

config.h  : config.h.in
	./configure

version.c : make_version es.h
	./make_version $(CC) > version.c

etags : ${HFILES} ${CFILES} parse.y
	etags ${HFILES} ${CFILES} parse.y

# for linux use:

# extra file rules
%.es:


# --- dependencies ---

ESHFILES = config.h esconfig.h stdenv.h es.h

stdenv.h : esconfig.h
es.h : config.h stdenv.h
access.o : access.c ${ESHFILES} prim.h
closure.o : closure.c ${ESHFILES} gc.h
conv.o : conv.c ${ESHFILES} print.h
dict.o : dict.c ${ESHFILES} gc.h
eval.o : eval.c ${ESHFILES}
except.o : except.c ${ESHFILES} print.h
fd.o : fd.c ${ESHFILES}
gc.o : gc.c ${ESHFILES} gc.h
glob.o : glob.c ${ESHFILES} gc.h
glom.o : glom.c ${ESHFILES} gc.h
input.o : input.c ${ESHFILES} input.h
heredoc.o : heredoc.c ${ESHFILES} gc.h input.h syntax.h
list.o : list.c ${ESHFILES} gc.h
main.o : main.c ${ESHFILES} token.h
match.o : match.c ${ESHFILES}
open.o : open.c ${ESHFILES}
opt.o : opt.c ${ESHFILES}
prim.o : prim.c ${ESHFILES} prim.h
prim-ctl.o : prim-ctl.c ${ESHFILES} prim.h
prim-etc.o : prim-etc.c ${ESHFILES} prim.h
prim-io.o : prim-io.c ${ESHFILES} gc.h prim.h
prim-sys.o : prim-sys.c ${ESHFILES} prim.h
prim-dict.o : prim-dict.c ${ESHFILES} prim.h
print.o : print.c ${ESHFILES} print.h
proc.o : proc.c ${ESHFILES} prim.h
signal.o : signal.c ${ESHFILES} sigmsgs.h
split.o : split.c ${ESHFILES} gc.h
status.o : status.c ${ESHFILES}
str.o : str.c ${ESHFILES} gc.h print.h
syntax.o : syntax.c ${ESHFILES} input.h syntax.h token.h
term.o : term.c ${ESHFILES} gc.h
token.o : token.c ${ESHFILES} input.h syntax.h token.h
tree.o : tree.c ${ESHFILES} gc.h
util.o : util.c ${ESHFILES}
var.o : var.c ${ESHFILES} gc.h var.h
vec.o : vec.c ${ESHFILES} gc.h
version.o : version.c ${ESHFILES}

